sudo: required
language: node_js 
node_js: 
  - "12"
services:
  - docker

before_install:
  - wget -qO- https://toolbelt.heroku.com/install.sh | sh
  - echo "$DOCKER_PSWD" | docker login -u "$DOCKER_USER" --password-stdin
  - echo "$HEROKU_PSWD" | docker login -u "_" --password-stdin registry.heroku.com #logged in

script:
  - docker build -t $DOCKER_USER/smbr_client -f client/Dockerfile.client client;
  - docker tag $DOCKER_USER/smbr_client registry.heroku.com/$HEROKU_CLIENT/web;

  - docker build -t $DOCKER_USER/smbr_api -f api/Dockerfile.api api;
  - docker tag $DOCKER_USER/smbr_api registry.heroku.com/$HEROKU_API/web;
 
deploy:
  provider: script
  script: 
    # push to dockerhub & heroku 
    docker push $DOCKER_USER/smbr_client;
    docker push registry.heroku.com/$HEROKU_CLIENT/web;

    heroku container:release web --app $HEROKU_CLIENT;
   
    docker push $DOCKER_USER/smbr_api;
    docker push registry.heroku.com/$HEROKU_API/web;
    
    heroku container:release web --app $HEROKU_API;  

  on: 
    branch: master 